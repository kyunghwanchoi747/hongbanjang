// 성남 AI 민심 법정 - 데이터베이스 스키마
// 모듈형 설계: CITY_CODE 변수로 전국 복제 가능

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 도시 정보 (전국 확장용)
model City {
  id        String   @id @default(cuid())
  code      String   @unique // seongnam, seoul, busan...
  name      String   // 성남시, 서울시, 부산시...
  createdAt DateTime @default(now())

  cases     Case[]
  sources   DataSource[]
}

// 데이터 소스 (뉴스, 민원 게시판 등)
model DataSource {
  id        String   @id @default(cuid())
  cityId    String
  city      City     @relation(fields: [cityId], references: [id])
  name      String   // 성남시 민원게시판, 분당신문 등
  url       String
  type      String   // news, complaint, sns
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  rawData   RawData[]
}

// 수집된 원본 데이터
model RawData {
  id           String     @id @default(cuid())
  sourceId     String
  source       DataSource @relation(fields: [sourceId], references: [id])
  title        String
  content      String
  originalUrl  String?
  publishedAt  DateTime?
  scrapedAt    DateTime   @default(now())
  isProcessed  Boolean    @default(false)

  case         Case?      @relation(fields: [caseId], references: [id])
  caseId       String?
}

// 재판 사건
model Case {
  id            String    @id @default(cuid())
  cityId        String
  city          City      @relation(fields: [cityId], references: [id])
  caseNumber    String    @unique // 2024-성남-001
  title         String    // 사건명
  defendant     String    // 피고 (담당 부서/기관)
  issue         String    // 핵심 쟁점
  relatedLaws   String?   // 관련 법령
  status        String    @default("PENDING") // PENDING, IN_TRIAL, VOTING, CLOSED

  // 투표 결과
  guiltyVotes   Int       @default(0)
  notGuiltyVotes Int      @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  trialStartedAt DateTime?
  trialEndedAt  DateTime?

  rawData       RawData[]
  arguments     Argument[]
  votes         Vote[]
}

// AI 에이전트 발언
model Argument {
  id        String   @id @default(cuid())
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id])
  role      String   // PROSECUTOR, DEFENDER, JUDGE
  content   String
  replyToId String?
  replyTo   Argument? @relation("ArgumentReplies", fields: [replyToId], references: [id])
  replies   Argument[] @relation("ArgumentReplies")
  sequence  Int      // 발언 순서
  createdAt DateTime @default(now())
}

// 시민 투표
model Vote {
  id        String   @id @default(cuid())
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id])

  sessionId String   // 익명 세션 ID
  verdict   String   // GUILTY, NOT_GUILTY
  reason    String?  // 선택적 투표 이유
  createdAt DateTime @default(now())

  @@unique([caseId, sessionId])
}
